-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.allocations (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  allocation_key character varying NOT NULL UNIQUE,
  region_id uuid NOT NULL,
  department_id uuid NOT NULL,
  commune_id uuid NOT NULL,
  operator_id uuid NOT NULL,
  responsible_name character varying NOT NULL,
  responsible_phone_raw character varying,
  responsible_phone_normalized character varying,
  target_tonnage numeric NOT NULL CHECK (target_tonnage > 0::numeric),
  status USER-DEFINED DEFAULT 'OPEN'::allocation_status,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  project_id uuid,
  CONSTRAINT allocations_pkey PRIMARY KEY (id),
  CONSTRAINT allocations_region_id_fkey FOREIGN KEY (region_id) REFERENCES public.regions(id),
  CONSTRAINT allocations_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id),
  CONSTRAINT allocations_commune_id_fkey FOREIGN KEY (commune_id) REFERENCES public.communes(id),
  CONSTRAINT allocations_operator_id_fkey FOREIGN KEY (operator_id) REFERENCES public.operators(id),
  CONSTRAINT allocations_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.project(id)
);
CREATE TABLE public.communes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  department_id uuid NOT NULL,
  name character varying NOT NULL,
  code character varying NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  distance_mine numeric,
  CONSTRAINT communes_pkey PRIMARY KEY (id),
  CONSTRAINT communes_department_id_fkey FOREIGN KEY (department_id) REFERENCES public.departments(id)
);
CREATE TABLE public.deliveries (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  allocation_id uuid NOT NULL,
  bl_number character varying UNIQUE,
  truck_id uuid,
  driver_id uuid,
  tonnage_loaded numeric NOT NULL CHECK (tonnage_loaded > 0::numeric),
  delivery_date timestamp with time zone,
  created_by uuid,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  payments_id uuid,
  CONSTRAINT deliveries_pkey PRIMARY KEY (id),
  CONSTRAINT deliveries_allocation_id_fkey FOREIGN KEY (allocation_id) REFERENCES public.allocations(id),
  CONSTRAINT deliveries_truck_id_fkey FOREIGN KEY (truck_id) REFERENCES public.trucks(id),
  CONSTRAINT deliveries_driver_id_fkey FOREIGN KEY (driver_id) REFERENCES public.drivers(id),
  CONSTRAINT deliveries_payments_id_fkey FOREIGN KEY (payments_id) REFERENCES public.payments(id)
);
CREATE TABLE public.departments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  region_id uuid NOT NULL,
  name character varying NOT NULL,
  code character varying NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT departments_pkey PRIMARY KEY (id),
  CONSTRAINT departments_region_id_fkey FOREIGN KEY (region_id) REFERENCES public.regions(id)
);
CREATE TABLE public.drivers (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name character varying NOT NULL,
  phone_normalized character varying UNIQUE,
  license_number character varying UNIQUE,
  status character varying DEFAULT 'ACTIVE'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  truck_id uuid,
  CONSTRAINT drivers_pkey PRIMARY KEY (id),
  CONSTRAINT drivers_truck_id_fkey FOREIGN KEY (truck_id) REFERENCES public.trucks(id)
);
CREATE TABLE public.operators (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name character varying NOT NULL,
  contact_info character varying,
  created_at timestamp with time zone DEFAULT now(),
  commune_id uuid,
  operateur_coop_gie boolean,
  coop_name text,
  projet_id uuid,
  CONSTRAINT operators_pkey PRIMARY KEY (id),
  CONSTRAINT operators_commune_id_fkey FOREIGN KEY (commune_id) REFERENCES public.communes(id),
  CONSTRAINT operators_projet_id_fkey FOREIGN KEY (projet_id) REFERENCES public.project(id)
);
CREATE TABLE public.payments (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  truck_id uuid NOT NULL,
  delivery_id uuid NOT NULL,
  road_fees numeric DEFAULT 0,
  personal_fees numeric DEFAULT 0,
  other_fees numeric DEFAULT 0,
  other_fees_label text,
  overweigh_fees numeric DEFAULT 0,
  fuel_quantity numeric DEFAULT 0,
  fuel_cost numeric DEFAULT 0,
  date_updated timestamp with time zone DEFAULT now(),
  created_at timestamp with time zone DEFAULT now(),
  loading_cost numeric,
  unloading_cost numeric,
  CONSTRAINT payments_pkey PRIMARY KEY (id),
  CONSTRAINT payments_truck_id_fkey FOREIGN KEY (truck_id) REFERENCES public.trucks(id),
  CONSTRAINT payments_delivery_id_fkey FOREIGN KEY (delivery_id) REFERENCES public.deliveries(id)
);
CREATE TABLE public.production (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  project_id uuid NOT NULL,
  production_date date NOT NULL DEFAULT CURRENT_DATE,
  bags_deployed integer NOT NULL CHECK (bags_deployed >= 0),
  bags_filled_50kg integer NOT NULL CHECK (bags_filled_50kg >= 0),
  tonnage numeric DEFAULT ((bags_filled_50kg)::numeric / (20)::numeric),
  total_amount numeric DEFAULT 0 CHECK (total_amount >= 0::numeric),
  notes text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  nombre_elements numeric,
  equipe_couture numeric,
  CONSTRAINT production_pkey PRIMARY KEY (id),
  CONSTRAINT production_project_id_fkey FOREIGN KEY (project_id) REFERENCES public.project(id)
);
CREATE TABLE public.project (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  numero_marche character varying DEFAULT ''::character varying,
  numero_bon_disposition character varying DEFAULT ''::character varying,
  numero_phase smallint,
  date_mise_disposition date,
  tonnage_total smallint,
  CONSTRAINT project_pkey PRIMARY KEY (id)
);
CREATE TABLE public.regions (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name character varying NOT NULL UNIQUE,
  code character varying NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT regions_pkey PRIMARY KEY (id)
);
CREATE TABLE public.trucks (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  plate_number character varying NOT NULL UNIQUE,
  capacity_tonnes numeric DEFAULT 50.00,
  status character varying DEFAULT 'AVAILABLE'::character varying,
  created_at timestamp with time zone DEFAULT now(),
  trailer_number character varying,
  owner_type boolean NOT NULL DEFAULT true,
  qrcode_content text,
  updated_at date,
  CONSTRAINT trucks_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_preferences (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid NOT NULL UNIQUE,
  user_email text UNIQUE,
  theme_mode text NOT NULL DEFAULT 'light'::text CHECK (theme_mode = ANY (ARRAY['light'::text, 'dark'::text])),
  theme_color text NOT NULL DEFAULT 'default'::text,
  theme_name text NOT NULL DEFAULT 'Light'::text,
  sidebar_pinned boolean NOT NULL DEFAULT false,
  language text NOT NULL DEFAULT 'fr'::text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  user_right_level numeric,
  user_pswd text,
  user_statut boolean DEFAULT false,
  CONSTRAINT user_preferences_pkey PRIMARY KEY (id)
);